name: Update iNaturalist Observations

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      taxon_id:
        description: 'Taxon ID (e.g., 551307 for sharks, 3 for birds)'
        required: false
        default: '551307'
      quality_grade:
        description: 'Quality grade (research, needs_id, or leave blank for both)'
        required: false
        default: ''
      count:
        description: 'Number of observations (max 200)'
        required: false
        default: '30'
      term_id:
        description: 'Annotation term ID (e.g., 1 for Life Stage, 17 for Dead or Alive)'
        required: false
        default: '17'
      term_value_id:
        description: 'Annotation value ID (e.g., 2 for Adult, 18 for Alive)'
        required: false
        default: '18'

jobs:
  update-inat:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Scrape iNaturalist observations
      run: |
        CMD="python scripts/scrape_inat.py"
        
        TAXON="${{ github.event.inputs.taxon_id || '551307' }}"
        QUALITY="${{ github.event.inputs.quality_grade }}"
        COUNT="${{ github.event.inputs.count || '30' }}"
        TERM_ID="${{ github.event.inputs.term_id || '1' }}"
        TERM_VALUE="${{ github.event.inputs.term_value_id || '2' }}"
        
        CMD="$CMD --taxon=$TAXON"
        echo "Using taxon ID: $TAXON"
        
        if [ -n "$QUALITY" ]; then
          CMD="$CMD --quality=$QUALITY"
          echo "Quality grade: $QUALITY"
        fi
        
        CMD="$CMD --count=$COUNT"
        echo "Count: $COUNT"
        
        # Add annotation filters (Life Stage: Adult)
        if [ -n "$TERM_ID" ]; then
          CMD="$CMD --term_id=$TERM_ID"
          echo "Term ID: $TERM_ID"
        fi
        
        if [ -n "$TERM_VALUE" ]; then
          CMD="$CMD --term_value_id=$TERM_VALUE"
          echo "Term Value ID: $TERM_VALUE"
        fi
        
        echo "Running: $CMD"
        $CMD
      
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add inatslide/observations.json
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update iNaturalist observations - $(date '+%Y-%m-%d')"
          git push
        fi
