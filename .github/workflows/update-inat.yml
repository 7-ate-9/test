name: Update iNaturalist Observations

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      taxon_id:
        description: 'Taxon ID (e.g., 551307 for sharks, 3 for birds)'
        required: false
        default: '551307'
      quality_grade:
        description: 'Quality grade (research, needs_id, or leave blank for both)'
        required: false
        default: ''
      count:
        description: 'Number of observations (max 200)'
        required: false
        default: '30'
      term_id:
        description: 'Annotation term ID (e.g., 1 for Life Stage, 17 for Dead or Alive)'
        required: false
        default: '17'
      term_value_id:
        description: 'Annotation value ID (e.g., 2 for Adult, 18 for Alive)'
        required: false
        default: '18'

jobs:
  update-inat:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Scrape iNaturalist observations
      run: |
        CMD="python scripts/scrape_inat.py"
        
        # Use inputs if manually triggered, otherwise use defaults
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAXON="${{ github.event.inputs.taxon_id }}"
          QUALITY="${{ github.event.inputs.quality_grade }}"
          COUNT="${{ github.event.inputs.count }}"
          TERM_ID="${{ github.event.inputs.term_id }}"
          TERM_VALUE="${{ github.event.inputs.term_value_id }}"
        else
          # Scheduled run - use hardcoded defaults
          TAXON="551307"
          QUALITY=""
          COUNT="30"
          TERM_ID="17"
          TERM_VALUE="18"
        fi
        
        CMD="$CMD --taxon=${TAXON:-551307}"
        echo "Using taxon ID: ${TAXON:-551307}"
        
        if [ -n "$QUALITY" ]; then
          CMD="$CMD --quality=$QUALITY"
          echo "Quality grade: $QUALITY"
        fi
        
        CMD="$CMD --count=${COUNT:-30}"
        echo "Count: ${COUNT:-30}"
        
        # Add annotation filters (Dead or Alive: Alive)
        CMD="$CMD --term_id=${TERM_ID:-17}"
        echo "Term ID: ${TERM_ID:-17}"
        
        CMD="$CMD --term_value_id=${TERM_VALUE:-18}"
        echo "Term Value ID: ${TERM_VALUE:-18}"
        
        echo "Running: $CMD"
        $CMD
      
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add inatslide/observations.json
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update iNaturalist observations - $(date '+%Y-%m-%d')"
          git push
        fi
