---
layout: default
title: eBird Voice Input
---

<div id="root"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<script type="text/babel">
const { useState } = React;

const Button = ({ children, onClick, disabled, variant = 'default', className = '' }) => {
  const baseStyles = 'px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center';
  const variants = {
    default: 'bg-blue-600 text-white hover:bg-blue-700',
    outline: 'border-2 border-gray-300 hover:bg-gray-100'
  };
  return (
    <button 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyles} ${variants[variant]} ${className}`}
    >
      {children}
    </button>
  );
};

const Card = ({ children, className = '' }) => (
  <div className={`bg-white rounded-lg shadow-lg ${className}`}>{children}</div>
);

const CardHeader = ({ children }) => (
  <div className="px-6 py-4 border-b">{children}</div>
);

const CardTitle = ({ children }) => (
  <h2 className="text-2xl font-bold">{children}</h2>
);

const CardContent = ({ children, className = '' }) => (
  <div className={`px-6 py-4 ${className}`}>{children}</div>
);

const Alert = ({ children, variant = 'default' }) => {
  const variants = {
    default: 'bg-blue-50 border-blue-200',
    destructive: 'bg-red-50 border-red-200'
  };
  return (
    <div className={`border-2 rounded-lg p-4 ${variants[variant]}`}>
      {children}
    </div>
  );
};

const AlertDescription = ({ children, className = '' }) => (
  <div className={className}>{children}</div>
);

const Mic = ({ className }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
  </svg>
);

const MicOff = ({ className }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
  </svg>
);

const Download = ({ className }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
  </svg>
);

const Trash = ({ className }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
  </svg>
);

const EBirdVoiceInput = () => {
  const [isListening, setIsListening] = useState(false);
  const [birds, setBirds] = useState([]);
  const [transcript, setTranscript] = useState('');
  const [error, setError] = useState('');
  const [debugInfo, setDebugInfo] = useState('');
  const [coords, setCoords] = useState(null);
  const [recognitionInstance, setRecognitionInstance] = useState(null);

  const processCommand = (command) => {
    const lower = command.toLowerCase();
    
    if (lower.includes('done') || lower.includes('stop') || lower.includes('finish')) {
      stopListening();
      return true;
    }
    
    const modifyMatch = lower.match(/(add|plus|subtract|minus|remove)\s+(\d+)\s+(.+)/);
    if (modifyMatch) {
      const [_, action, countStr, species] = modifyMatch;
      const count = parseInt(countStr);
      const cleanSpecies = species.trim();
      
      if (action === 'subtract' || action === 'minus' || action === 'remove') {
        modifyBirdCount(cleanSpecies, -count);
      } else {
        modifyBirdCount(cleanSpecies, count);
      }
      return true;
    }
    
    let match = lower.match(/^(\d+)\s+(.+)/);
    if (match) {
      const [_, count, species] = match;
      addBird(parseInt(count), species.trim());
      return true;
    }
    
    match = lower.match(/(.+?)[,\s]+(\d+)$/);
    if (match) {
      const [_, species, count] = match;
      addBird(parseInt(count), species.trim());
      return true;
    }
    
    match = lower.match(/saw\s+(\d+)\s+(.+)/);
    if (match) {
      const [_, count, species] = match;
      addBird(parseInt(count), species.trim());
      return true;
    }
    
    if (lower.length > 2 && !lower.match(/^\d/) && !lower.includes('add') && !lower.includes('subtract')) {
      addBird(1, lower.trim());
      return true;
    }
    
    return false;
  };
  
  const addBird = (count, species) => {
    const now = new Date();
    const newBird = {
      species: species,
      count: count,
      date: now.toISOString().split('T')[0],
      time: now.toTimeString().split(' ')[0],
      lat: coords?.latitude || null,
      lng: coords?.longitude || null
    };
    setBirds(prev => [...prev, newBird]);
  };
  
  const modifyBirdCount = (species, delta) => {
    setBirds(prev => {
      const existing = prev.find(b => b.species.toLowerCase() === species.toLowerCase());
      if (existing) {
        return prev.map(b => {
          if (b.species.toLowerCase() === species.toLowerCase()) {
            const newCount = Math.max(0, b.count + delta);
            if (newCount === 0) {
              return null;
            }
            return { ...b, count: newCount };
          }
          return b;
        }).filter(b => b !== null);
      } else if (delta > 0) {
        addBird(delta, species);
        return prev;
      }
      return prev;
    });
  };

  const startListening = () => {
    setError('');
    setTranscript('');
    setDebugInfo('Initializing speech recognition...');

    if (navigator.geolocation && !coords) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setCoords({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          });
        },
        (error) => {
          console.log('Geolocation error:', error);
        }
      );
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      setError('Speech recognition is not supported in your browser.');
      setDebugInfo('No SpeechRecognition constructor found');
      return;
    }

    try {
      const recognition = new SpeechRecognition();
      setDebugInfo('Recognition instance created');
      
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onstart = () => {
        setIsListening(true);
        setError('');
        setDebugInfo('Recognition started successfully');
      };

      recognition.onresult = (event) => {
        const lastResult = event.results[event.results.length - 1];
        const command = lastResult[0].transcript;
        setTranscript(command);
        setDebugInfo('Received speech result');
        
        if (!processCommand(command)) {
          setError('Not recognized. Try: "3 American Robin" or say "Done" to finish');
        }
      };

      recognition.onerror = (event) => {
        setDebugInfo(`Error type: ${event.error}, Error message: ${event.message || 'No message'}`);
        
        switch (event.error) {
          case 'no-speech':
            break;
          case 'aborted':
            break;
          case 'audio-capture':
            setError('No microphone was found. Please check your microphone settings.');
            setIsListening(false);
            break;
          case 'network':
            setError('Network error occurred. Please check your connection.');
            setIsListening(false);
            break;
          case 'not-allowed':
            setError('Microphone access was denied. Please check your permissions.');
            setIsListening(false);
            break;
          case 'service-not-allowed':
            setError('Speech service is not allowed. Please try again.');
            setIsListening(false);
            break;
          default:
            setError(`Recognition error: ${event.error}`);
            setIsListening(false);
        }
      };

      recognition.onend = () => {
        setDebugInfo(prev => prev + '\nRecognition ended');
        if (isListening) {
          try {
            recognition.start();
          } catch (e) {
            setIsListening(false);
          }
        }
      };

      setDebugInfo(prev => prev + '\nStarting recognition...');
      recognition.start();
      setRecognitionInstance(recognition);
      
    } catch (err) {
      console.error('Recognition error:', err);
      setError(`Failed to start speech recognition: ${err.message}`);
      setDebugInfo(`Error detail: ${err.toString()}`);
      setIsListening(false);
    }
  };
  
  const stopListening = () => {
    if (recognitionInstance) {
      setIsListening(false);
      recognitionInstance.stop();
      setRecognitionInstance(null);
    }
  };

  const generateCSV = () => {
    const headers = ['Common Name', 'Count', 'Latitude', 'Longitude', 'Date', 'Time', 'Protocol'];
    const rows = birds.map(bird => [
      bird.species,
      bird.count,
      bird.lat || '',
      bird.lng || '',
      bird.date,
      bird.time,
      'Incidental'
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ebird-checklist-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  return (
    <Card className="w-full max-w-2xl mx-auto my-8">
      <CardHeader>
        <CardTitle>eBird Voice Input</CardTitle>
      </CardHeader>
      <CardContent className="space-y-6">
        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
          <h3 className="font-bold text-base mb-2">üìã Voice Commands:</h3>
          <div className="text-sm space-y-1">
            <div><strong>Add birds:</strong> "3 American Robin" or "Blue Jay" (assumes 1)</div>
            <div><strong>Modify count:</strong> "Add 2 American Robin" or "Subtract 1 Blue Jay"</div>
            <div><strong>Natural speech:</strong> "I saw 5 Cardinals"</div>
            <div><strong>Finish:</strong> "Done" or "Stop"</div>
          </div>
          {!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window) && (
            <div className="mt-2 text-sm text-red-600 font-medium">
              ‚ö†Ô∏è Speech recognition not supported. Please use Chrome, Edge, or Samsung Internet.
            </div>
          )}
        </div>

        <div className="flex flex-col gap-4">
          <Button 
            onClick={isListening ? stopListening : startListening}
            className="h-20 text-xl"
          >
            {isListening ? <MicOff className="mr-3 h-8 w-8" /> : <Mic className="mr-3 h-8 w-8" />}
            {isListening ? 'Stop Listening' : 'Start Listening'}
          </Button>
          <div className="flex gap-4">
            <Button
              onClick={() => setBirds([])}
              variant="outline"
              className="flex-1 h-16 text-lg"
            >
              <Trash className="mr-2 h-6 w-6" />
              Clear
            </Button>
            <Button
              onClick={generateCSV}
              disabled={birds.length === 0}
              variant="outline"
              className="flex-1 h-16 text-lg"
            >
              <Download className="mr-2 h-6 w-6" />
              Download
            </Button>
          </div>
        </div>

        {error && (
          <Alert variant="destructive">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        {isListening && (
          <Alert>
            <AlertDescription className="text-lg">
              üé§ Listening... Say bird name and count (e.g., "3 American Robin"). Say "Done" to finish.
            </AlertDescription>
          </Alert>
        )}

        {transcript && (
          <div className="text-lg text-gray-700 font-medium">
            Last heard: {transcript}
          </div>
        )}

        <div className="border-2 rounded-lg p-4">
          <h3 className="font-bold text-lg mb-3">Recorded Sightings ({birds.length}):</h3>
          {birds.length === 0 ? (
            <p className="text-base text-gray-500">No birds recorded yet.</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-left">
                <thead>
                  <tr className="border-b-2">
                    <th className="pb-2 pr-4">Count</th>
                    <th className="pb-2 pr-4">Species</th>
                    <th className="pb-2">Time</th>
                  </tr>
                </thead>
                <tbody>
                  {birds.map((bird, index) => (
                    <tr key={index} className="border-b">
                      <td className="py-2 pr-4 text-lg font-bold">{bird.count}</td>
                      <td className="py-2 pr-4 text-base">{bird.species}</td>
                      <td className="py-2 text-sm text-gray-600">{bird.time}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {coords && (
          <div className="text-sm text-gray-500">
            üìç Location: {coords.latitude.toFixed(4)}, {coords.longitude.toFixed(4)}
          </div>
        )}

        <div className="text-xs text-gray-400 whitespace-pre-wrap">
          {debugInfo}
        </div>
      </CardContent>
    </Card>
  );
};

ReactDOM.render(<EBirdVoiceInput />, document.getElementById('root'));
</script>
